<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jungle Runner</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #game-wrapper { display: flex; width: 100vw; height: 100vh; background: #333; position: relative; }
        
        /* V√°ch ngƒÉn trung t√¢m */
        #divider { position: absolute; left: 50%; top: 0; width: 6px; height: 100%; background: #f1c40f; transform: translateX(-50%); z-index: 50; box-shadow: 0 0 15px #f1c40f; }
        
        .screen { position: relative; flex: 1; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; background: #1a2533; }
        
        #word-prompt-container { position: absolute; top: 10%; width: 100%; display: flex; justify-content: center; z-index: 100; pointer-events: none; }
        .word-box { background: rgba(0,0,0,0.9); padding: 15px; border-radius: 12px; border: 3px solid #f1c40f; text-align: center; min-width: 150px; }
        .prompt-img { max-height: 100px; display: block; margin: 0 auto; border-radius: 5px; }
        .prompt-text { font-size: 28px; color: #f1c40f; font-weight: bold; margin-top: 5px; }
        
        #announcement { position: absolute; top: 40%; width: 100%; text-align: center; font-size: 50px; color: #ff3333; font-weight: bold; display: none; z-index: 60; text-shadow: 0 0 15px #000; }
        .stats { position: absolute; bottom: 20px; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 8px; font-size: 13px; z-index: 20; }
        #file-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200; }
        .blinking { animation: blink 0.4s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="file-overlay">
    <h2>üèéÔ∏è JUNGLE RUNNER</h2>
    <p>Race against newest AI, who drives longest win.</p>
    <input type="file" id="fileInput" accept=".json,.txt">
</div>

<div id="divider"></div>

<div id="word-prompt-container">
    <div id="word-box" class="word-box" style="display: none;">
        <img id="prompt-image" class="prompt-img" src="">
        <div id="prompt-text" class="prompt-text"></div>
    </div>
</div>

<div id="announcement" class="blinking">WATCH OUT!</div>

<div id="game-wrapper">
    <div class="screen">
        <div class="stats" style="left: 10px;">M·∫°ng: <span id="p-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span> | Chu·ªói: <span id="p-streak">0</span></div>
        <canvas id="canvasPlayer"></canvas>
    </div>
    <div class="screen">
        <div class="stats" style="right: 10px; text-align: right;">Chu·ªói AI: <span id="ai-streak">0</span> | <span id="speed-tag">x2.0</span></div>
        <canvas id="canvasAI"></canvas>
    </div>
</div>

<script>
const LANE_WIDTH = 130;
const CANVAS_WIDTH = LANE_WIDTH * 3;
const playerImg = new Image(); playerImg.src = 'car1.png';
const aiImg = new Image(); aiImg.src = 'car2.png';
const bgImg = new Image(); bgImg.src = 'bg.png';

let vocab = [], objects = [], speedLines = [];
let gameState = 'START', isSlowMo = false, isNitro = false, isCooldown = false;
let bgY = 0, difficulty = 2.0, pairsAnswered = 0, shakeIntensity = 0;
let fileType = ''; // 'json' ho·∫∑c 'txt'

const player = { lane: 1, x: LANE_WIDTH * 1.5, y: 0, lives: 3, streak: 0 };
const ai = { lane: 1, x: LANE_WIDTH * 1.5, streak: 0, targetLane: 1 };

for(let i=0; i<25; i++) speedLines.push({ x: Math.random()*CANVAS_WIDTH, y: Math.random()*800, l: Math.random()*40+20 });

// --- ƒêI·ªÄU KHI·ªÇN ---
let touchStartX = 0;
window.addEventListener('touchstart', e => {
    touchStartX = e.touches[0].clientX;
    const rect = document.getElementById('canvasPlayer').getBoundingClientRect();
    const x = (e.touches[0].clientX - rect.left) * (CANVAS_WIDTH / rect.width);
    const y = (e.touches[0].clientY - rect.top) * (window.innerHeight / rect.height);
    if (x > player.x - 50 && x < player.x + 50 && y > player.y - 20 && y < player.y + 120) isNitro = true;
});

window.addEventListener('touchend', e => {
    isNitro = false;
    let touchEndX = e.changedTouches[0].clientX;
    let diff = touchEndX - touchStartX;
    if (Math.abs(diff) > 30) { // Ng∆∞·ª°ng vu·ªët
        if (diff > 0) player.lane = Math.min(2, player.lane + 1);
        else player.lane = Math.max(0, player.lane - 1);
    }
});

window.addEventListener('keydown', e => {
    if (e.key === 'ArrowLeft') player.lane = Math.max(0, player.lane - 1);
    if (e.key === 'ArrowRight') player.lane = Math.min(2, player.lane + 1);
    if (e.key === ' ') isNitro = true;
});
window.addEventListener('keyup', e => { if (e.key === ' ') isNitro = false; });

// --- X·ª¨ L√ù FILE ---
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    fileType = file.name.split('.').pop().toLowerCase();
    const reader = new FileReader();
    reader.onload = (ev) => {
        if (fileType === 'json') {
            vocab = JSON.parse(ev.target.result).map(item => ({ q: item.en, url: item.url, a: item.en }));
        } else {
            const lines = ev.target.result.split(/\r?\n/).filter(l => l.trim());
            for (let i = 0; i < lines.length; i += 2) vocab.push({ q: lines[i], a: lines[i+1], url: '' });
        }
        document.getElementById('file-overlay').style.display = 'none';
        gameState = 'PLAYING';
        resize();
        requestAnimationFrame(gameLoop);
    };
    reader.readAsText(file);
});

function spawn() {
    if (isCooldown || objects.length > 0) return;
    if (pairsAnswered > 0 && pairsAnswered % 5 === 0) { triggerWatchOut(); return; }

    isSlowMo = true;
    const current = vocab[Math.floor(Math.random() * vocab.length)];
    const box = document.getElementById('word-box');
    const pImg = document.getElementById('prompt-image');
    const pTxt = document.getElementById('prompt-text');

    if (fileType === 'json') {
        pImg.src = current.url; pImg.style.display = 'block';
        pTxt.innerText = ''; // Kh√¥ng hi·ªán ch·ªØ khi d√πng JSON
    } else {
        pImg.style.display = 'none';
        pTxt.innerText = current.q;
    }
    box.style.display = 'block';

    const correctLane = Math.floor(Math.random() * 3);
    const distractors = vocab.filter(v => v.a !== current.a).sort(() => 0.5 - Math.random());
    for(let i=0; i<3; i++) {
        objects.push({ 
            type: 'GATE', lane: i, y: -500, 
            text: i === correctLane ? current.a : distractors[i].a, 
            isCorrect: i === correctLane 
        });
    }
    ai.targetLane = (Math.random() < 0.5) ? Math.floor(Math.random()*3) : correctLane;
}

function triggerWatchOut() {
    isCooldown = true;
    document.getElementById('announcement').style.display = 'block';
    let spawned = 0;
    const interval = setInterval(() => {
        objects.push({ type: 'CAR', lane: Math.floor(Math.random()*3), y: -200 });
        spawned++;
        if (spawned >= 6) {
            clearInterval(interval);
            setTimeout(() => { isCooldown = false; pairsAnswered = 0; document.getElementById('announcement').style.display = 'none'; }, 3500);
        }
    }, 800);
}

function update() {
    let speed = isNitro ? 22 : (isSlowMo ? 3.5 : 8 * (difficulty/2));
    bgY = (bgY + speed) % window.innerHeight;
    player.x += ((player.lane * LANE_WIDTH + LANE_WIDTH/2) - player.x) * 0.25;
    ai.x += ((ai.targetLane * LANE_WIDTH + LANE_WIDTH/2) - ai.x) * 0.12;

    if (objects.length === 0 && !isCooldown) spawn();

    objects.forEach((obj) => {
        obj.y += speed;
        if (!obj.hit && obj.y > player.y - 15 && obj.y < player.y + 70 && obj.lane === player.lane) {
            obj.hit = true;
            if (obj.type === 'GATE') {
                if (obj.isCorrect) { player.streak++; pairsAnswered++; difficulty += 0.08; }
                else { player.lives--; player.streak = 0; shakeIntensity = 25; }
                isSlowMo = false; document.getElementById('word-box').style.display = 'none';
            } else { player.lives--; shakeIntensity = 35; }
            updateUI();
        }
    });
    objects = objects.filter(o => o.y < window.innerHeight + 100);
    speedLines.forEach(l => { l.y += speed * 2.5; if (l.y > window.innerHeight) { l.y = -50; l.x = Math.random() * CANVAS_WIDTH; } });
    if (shakeIntensity > 0) shakeIntensity *= 0.9;
}

function updateUI() {
    document.getElementById('p-lives').innerText = "‚ù§Ô∏è".repeat(Math.max(0, player.lives));
    document.getElementById('p-streak').innerText = player.streak;
    document.getElementById('ai-streak').innerText = ai.streak;
    document.getElementById('speed-tag').innerText = `x${difficulty.toFixed(1)}`;
}

function draw(canvasId, carX, isAI) {
    const c = document.getElementById(canvasId);
    const ctx = c.getContext('2d');
    ctx.clearRect(0, 0, c.width, c.height);
    ctx.save();
    if (!isAI && shakeIntensity > 1) ctx.translate((Math.random()-0.5)*shakeIntensity, (Math.random()-0.5)*shakeIntensity);

    const bgW = 120;
    if (isAI) {
        ctx.save(); ctx.translate(c.width, 0); ctx.scale(-1, 1);
        ctx.drawImage(bgImg, 0, bgY, bgW, c.height); ctx.drawImage(bgImg, 0, bgY - c.height, bgW, c.height);
        ctx.restore();
    } else {
        ctx.drawImage(bgImg, 0, bgY, bgW, c.height); ctx.drawImage(bgImg, 0, bgY - c.height, bgW, c.height);
    }

    // Speed Lines
    ctx.strokeStyle = isNitro ? "rgba(255,255,255,0.6)" : "rgba(255,255,255,0.15)";
    speedLines.forEach(l => { ctx.beginPath(); ctx.moveTo(l.x, l.y); ctx.lineTo(l.x, l.y + l.l); ctx.stroke(); });

    // V·∫≠t th·ªÉ
    objects.forEach(obj => {
        if (obj.type === 'GATE') {
            ctx.fillStyle = "#34495e"; // M√†u c·ªïng trung t√≠nh (Kh√≥ ƒëo√°n)
            ctx.fillRect(obj.lane*LANE_WIDTH + 15, obj.y, LANE_WIDTH - 30, 45);
            ctx.fillStyle = "white"; ctx.font = "bold 18px Arial"; ctx.textAlign = "center";
            ctx.fillText(obj.text, obj.lane*LANE_WIDTH + LANE_WIDTH/2, obj.y + 28);
        } else {
            ctx.save(); ctx.translate(obj.lane*LANE_WIDTH + LANE_WIDTH/2, obj.y + 50); ctx.rotate(Math.PI);
            ctx.drawImage(aiImg, -35, -50, 70, 100); ctx.restore();
        }
    });

    ctx.drawImage(isAI ? aiImg : playerImg, carX - 35, player.y, 70, 100);
    ctx.restore();
}

function gameLoop() {
    update();
    draw('canvasPlayer', player.x, false);
    draw('canvasAI', ai.x, true);
    if (player.lives > 0) requestAnimationFrame(gameLoop);
    else { alert("GAME OVER!"); location.reload(); }
}

function resize() {
    const ch = window.innerHeight;
    [document.getElementById('canvasPlayer'), document.getElementById('canvasAI')].forEach(c => { c.width = CANVAS_WIDTH; c.height = ch; });
    player.y = ch - 180;
}

window.addEventListener('resize', resize);
resize();
</script>
</body>
</html>